from had.shourtcuts import render, redirect, error_render
from project import settings
from had.authenticate import login_redirect, logout_redirect
import urllib.parse
from datetime import datetime, timedelta
from http.cookies import SimpleCookie
from .forms import SignupForm, LoginForm
from project.tree import Tree, gen_tree_htmls  # , gen_pages_ordered_by_tree
import traceback
import logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)
table_name = "table-wiki-stg"

def signup(request):
  import boto3
  import botocore
  # 参考
  # https://qiita.com/cloud-solution/items/3a770fb763efcf92a4a9
  if request.method == "POST":
    form = SignupForm(**request.body)
    Item = form.data
    client = boto3.client('cognito-idp', region_name=settings.AWS["region"])
    username = Item['username']
    email = Item['email']
    password = Item['password']
    try:
      ###############################################################################
      return render(
        request, 'accounts/signup.html', 
        context={
          "error":"現在はユーザ登録を受け付けていません",
          "form":form,
          "nav_tree_htmls": gen_tree_htmls(request, table_name, a_white=True)
        }
      )
      ###############################################################################
      # ユーザの作成
      response = client.admin_create_user(
        UserPoolId=settings.AWS["cognito"]["userPoolID"],
        Username=username,
        UserAttributes=[
          {
            'Name': 'email',
            'Value': email
          },   
          {
            'Name': 'email_verified',  # メールアドレスが確認済みかどうかを指定
            'Value': 'true'
          }
        ],
        # MessageAction='RESEND',
        # DesiredDeliveryMediums=['EMAIL']
        # メッセージ送信は抑止
        MessageAction='SUPPRESS',
        # 一時パスワードは未設定(次の処理で永続的なパスワードを)
        # TemporaryPassword = '',
      )
      # パスワードの設定
      # Permanentで永続的なパスワードに設定する。
      response = client.admin_set_user_password(
        UserPoolId=settings.AWS["cognito"]["userPoolID"],
        Username=username,
        Password=password,
        Permanent=True,
      )
      return redirect(settings.LOGIN_URL)
    except botocore.exceptions.ClientError as error:
      if error.response['Error']['Code'] == 'UsernameExistsException':
        return render(
          request, 'accounts/signup.html', 
          context={
            "error":"ユーザ名かメールアドレスが既に存在しています",
            "form":form,
            "nav_tree_htmls": gen_tree_htmls(request, table_name, a_white=True)
          }
        )
      elif error.response['Error']['Code'] == 'InvalidPasswordException':
        client.admin_delete_user(
            UserPoolId=settings.AWS["cognito"]["userPoolID"],
            Username=username
        )
        return render(
          request, 
          'accounts/signup.html', 
          context={
            "error":"パスワードを複雑にしてください",
            "nav_tree_htmls": gen_tree_htmls(request, table_name, a_white=True),
            "form":form
          }
        )
      else:
        logger.exception('Raise Exception: %s', error)
        return render(
          request, 
          'accounts/signup.html', 
          context={
            "error":"予期せぬエラーが発生しました",
            "nav_tree_htmls": gen_tree_htmls(request, table_name, a_white=True),
            "form":form
          }
        )
  else:
    form = SignupForm()
    context = {
      "error":"",
      "form":form,
      "nav_tree_htmls": gen_tree_htmls(request, table_name, a_white=True)
    }
    return render(request, 'accounts/signup.html', context=context)

def login(request):
  if request.auth:
    return redirect(settings.LOGIN_REDIRECT_URL)
  else:
    if request.method == "POST":
      form = LoginForm(**request.body)
      Item = form.data
      username = Item['username']
      password = Item['password']
      AuthParameters = {
        'USERNAME': username,
        'PASSWORD': password
      }
      response = login_redirect(AuthParameters, return_error=True)
      if response.__class__ == str:
        return render(
          request, 
          'accounts/login.html', 
          context={
            "error":response,
            "nav_tree_htmls": gen_tree_htmls(request, table_name, a_white=True)
          }
        )
      else:
        return response
    else:
      form = LoginForm()
      context = {
        "error":"",
        "form":form,
        "nav_tree_htmls": gen_tree_htmls(request, table_name, a_white=True)
      }
      return render(request, 'accounts/login.html', context=context)

def logout(request):
  return logout_redirect(request)


